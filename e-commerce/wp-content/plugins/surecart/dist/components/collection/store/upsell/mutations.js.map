{"version":3,"file":"mutations.js","sourceRoot":"","sources":["../../../src/store/upsell/mutations.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * External dependencies.\n */\nimport { addQueryArgs } from '@wordpress/url';\nimport apiFetch from '../../functions/fetch';\n\n/**\n * Internal dependencies.\n */\nimport { Checkout, LineItem, Price } from 'src/types';\nimport { state } from './store';\nimport { state as productState } from '../product';\nimport { createErrorNotice, removeNotice } from '@store/notices/mutations';\nimport { __ } from '@wordpress/i18n';\n\n/**\n * Update the upsell.\n */\nexport const trackOffer = () =>\n  apiFetch({\n    path: `surecart/v1/checkouts/${state.checkout_id}/offer_upsell/${state.upsell?.id}`,\n    method: 'POST',\n    keepalive: true, // Important: allow the request to outlive the page.\n  });\n\n/**\n * Update the upsell.\n */\nexport const preview = async () => {\n  try {\n    if (!state.checkout_id || state.loading === 'busy') {\n      return;\n    }\n\n    state.loading = 'busy';\n    removeNotice();\n\n    // Add Upsell to line item.\n    const { checkout, ...lineItem } = await upsellRequest({ preview: true });\n\n    state.checkout = checkout as Checkout;\n    state.line_item = lineItem as LineItem;\n  } catch (error) {\n    console.error(error);\n\n    if ((error?.additional_errors || []).find(error => error?.data?.options?.purchasable_statuses?.includes('out_of_stock'))) {\n      return createErrorNotice({ code: 'out_of_stock', message: __('Apologies, this is currently out of stock.', 'surecart') });\n    }\n\n    if ((error?.additional_errors || []).find(error => error?.code === 'line_item.upsell.expired')) {\n      state.loading = 'idle';\n      createErrorNotice({ code: 'expired', message: __('This offer has expired.', 'surecart') });\n      return decline();\n    }\n\n    createErrorNotice(error);\n  } finally {\n    state.loading = 'idle';\n  }\n};\n\nexport const accept = async () => {\n  try {\n    if (!state.checkout_id || state.loading === 'busy') {\n      return;\n    }\n\n    state.loading = 'busy';\n    removeNotice();\n\n    // Add Upsell to line item.\n    const { checkout } = await upsellRequest({ preview: false });\n\n    handleCompletion(checkout);\n  } catch (error) {\n    state.loading = 'idle';\n    createErrorNotice(error);\n  }\n};\n\n/**\n * Decline the upsell.\n */\nexport const decline = async () => {\n  try {\n    if (!state.checkout_id || state.loading === 'busy') {\n      return;\n    }\n\n    state.loading = 'busy';\n    removeNotice();\n\n    // Add Upsell to line item.\n    const checkout = (await apiFetch({\n      path: addQueryArgs(`surecart/v1/checkouts/${state.checkout_id}/decline_upsell/${state.upsell?.id}`, {\n        expand: ['checkout', 'checkout.current_upsell', 'fees'],\n      }),\n      method: 'POST',\n      data: {\n        ...productState[state.product?.id]?.line_item,\n        price_id: (state.upsell?.price as Price)?.id,\n        upsell: state.upsell?.id,\n        checkout: state.checkout_id,\n      },\n    })) as Checkout;\n\n    handleCompletion(checkout);\n  } catch (error) {\n    state.loading = 'idle';\n    createErrorNotice(error);\n  }\n};\n\n/**\n * Make the request to the upsell endpoing\n */\nexport const upsellRequest = args =>\n  apiFetch({\n    path: addQueryArgs('surecart/v1/line_items/upsell', {\n      ...args,\n      expand: ['checkout', 'checkout.current_upsell', 'checkout.manual_payment_method', 'fees', 'line_item', 'line_item.price'],\n    }),\n    method: 'POST',\n    data: {\n      ...productState[state.product?.id]?.line_item,\n      price_id: (state.upsell?.price as Price)?.id,\n      upsell: state.upsell?.id,\n      checkout: state.checkout_id,\n    },\n  }) as Promise<LineItem>;\n\n/**\n * Handle what to do on completion.\n */\nexport const handleCompletion = checkout => {\n  // There is no more upsells, or the link is the same.\n  if (!checkout.current_upsell?.permalink || checkout?.current_upsell?.permalink === state.upsell?.permalink) {\n    return (state.loading = 'complete');\n  }\n\n  // redirect to next upsell.\n  state.loading = 'redirecting';\n  window.location.assign(\n    addQueryArgs(checkout.current_upsell?.permalink, {\n      sc_checkout_id: state.checkout?.id,\n      sc_form_id: state.form_id,\n    }),\n  );\n};\n"]}