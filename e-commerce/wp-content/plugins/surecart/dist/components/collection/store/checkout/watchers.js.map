{"version":3,"file":"watchers.js","sourceRoot":"","sources":["../../../src/store/checkout/watchers.ts"],"names":[],"mappings":"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","sourcesContent":["import state, { onChange, on } from './store';\nimport { getCheckout, setCheckout } from '../checkouts/mutations';\nimport { onChange as onChangeFormState } from '../form';\nimport { updateFormState } from '../form/mutations';\nimport { Checkout, Invoice } from '../../types';\nimport { speak } from '@wordpress/a11y';\nimport { __, sprintf } from '@wordpress/i18n';\nimport { getFormattedPrice, getHumanDiscount } from '../../functions/price';\n\n/**\n * When the checkout changes, update the\n * checkout in localstorage.\n */\nonChange('checkout', val => setCheckout(val, state.formId));\n\n/**\n * When the checkout changes, update the mode to match the checkout.\n */\nonChange('checkout', val => {\n  if (val?.id) {\n    state.mode = !val?.live_mode ? 'test' : 'live';\n  }\n});\n\n// When the form state changes, update the form state based on the invoice status.\nonChangeFormState('formState', ({ value }) => {\n  if (value !== 'draft') return;\n\n  // if there is an invoice and it is not open, lock the form.\n  if ((state.checkout?.invoice as Invoice)?.status && (state.checkout?.invoice as Invoice)?.status !== 'open') {\n    updateFormState('LOCK');\n  }\n});\n\n/**\n * When checkout is get, get the checkout from the checkouts state.\n */\non('get', prop => {\n  if (prop === 'checkout') {\n    const checkout = getCheckout(state.formId, state.mode);\n    if (checkout?.id) {\n      state.checkout = checkout;\n    }\n  }\n});\n\non('set', (key: string, checkout: Checkout, oldCheckout: Checkout) => {\n  if (key !== 'checkout') return; // we only care about checkout\n  if (!oldCheckout || !checkout) return; // checkout was not updated.\n  if (checkout?.total_amount === oldCheckout?.total_amount && checkout?.amount_due === oldCheckout?.total_amount) return; // we only care about total_amount and amount_due\n\n  const amountDue = getFormattedPrice({\n    amount: checkout.amount_due,\n    currency: checkout.currency,\n  });\n  const totalAmount = getFormattedPrice({\n    amount: checkout.total_amount,\n    currency: checkout.currency,\n  });\n\n  const couponCodeAdded = checkout?.discount?.promotion?.code !== oldCheckout?.discount?.promotion?.code && checkout?.discount?.promotion?.code;\n  const couponCodeRemoved = checkout?.discount?.promotion?.code !== oldCheckout?.discount?.promotion?.code && !checkout?.discount?.promotion?.code;\n\n  const messages = [\n    ...(couponCodeRemoved ? [__('Coupon code removed.', 'sc-coupon-form')] : []),\n    ...(couponCodeAdded\n      ? [\n          sprintf(\n            // Translators: %1$s is the coupon code, %2$s is the human readable discount.\n            __('Coupon code %1$s added. %2$s applied.', 'sc-coupon-form'),\n            checkout?.discount?.promotion?.code,\n            getHumanDiscount(checkout?.discount?.coupon),\n          ),\n        ]\n      : []),\n    checkout.total_amount === checkout.amount_due\n      ? sprintf(__('Checkout updated. The amount due is %1$s.', 'surecart'), amountDue)\n      : sprintf(__('Checkout updated. The total amount for the checkout is %1$s and the amount due is %1$s.', 'surecart'), totalAmount, amountDue),\n  ];\n\n  speak(messages.join(' '));\n});\n"]}