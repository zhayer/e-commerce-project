{"version":3,"file":"storage.js","sourceRoot":"","sources":["../../../src/store/local/storage.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,WAAW,EAAE,MAAM,gBAAgB,CAAC;AAG7C,MAAM,QAAQ,GAAG,CAAmB,OAAuB,EAAE,GAAW,EAAY,EAAE;IACpF,IAAI,CAAC;QACH,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC;IAC1C,CAAC;IAAC,MAAM,CAAC;QACP,OAAO,IAAI,CAAC;IACd,CAAC;AACH,CAAC,CAAC;AAEF,MAAM,QAAQ,GAAG,EAAE,CAAC,EAAE;IACpB,IAAI,MAAM,GAAG,KAAK,CAAC;IACnB,OAAO,GAAG,EAAE;QACV,IAAI,MAAM,EAAE,CAAC;YACX,OAAO;QACT,CAAC;QACD,MAAM,GAAG,IAAI,CAAC;QACd,UAAU,CAAC,GAAG,EAAE;YACd,EAAE,EAAE,CAAC;YACL,MAAM,GAAG,KAAK,CAAC;QACjB,CAAC,EAAE,CAAC,CAAC,CAAC;IACR,CAAC,CAAC;AACJ,CAAC,CAAC;AAEF,MAAM,CAAC,MAAM,kBAAkB,GAAG,CAAmB,OAAuB,EAAE,GAAW,EAAE,aAAgB,EAAE,cAAc,GAAG,KAAK,EAAE,EAAE;;IACrI,MAAM,KAAK,GAAG,WAAW,CAAC,MAAA,QAAQ,CAAI,OAAO,EAAE,GAAG,CAAC,mCAAI,aAAa,EAAE,CAAC,QAAQ,EAAE,QAAQ,EAAE,EAAE;QAC3F,OAAO,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,KAAK,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;IAC/D,CAAC,CAAC,CAAC;IAEH,oEAAoE;IACpE,MAAM,KAAK,GAAG,QAAQ,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;IAChF,KAAK,EAAE,CAAC;IAER,IAAI,cAAc,EAAE,CAAC;QACnB,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,GAAG,EAAE;YACtC,MAAM,YAAY,GAAG,QAAQ,CAAI,OAAO,EAAE,GAAG,CAAC,CAAC;YAE/C,IAAI,YAAY,KAAK,IAAI,EAAE,CAAC;gBAC1B,OAAO;YACT,CAAC;YAED,KAAK,MAAM,GAAG,IAAI,YAAY,EAAE,CAAC;gBAC/B,KAAK,CAAC,GAAG,CAAC,GAAG,EAAE,YAAY,CAAC,GAAG,CAAC,CAAC,CAAC;YACpC,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,GAAG,CAAC,EAAE,GAAG,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;IAExC,OAAO,KAAK,CAAC;AACf,CAAC,CAAC;AAEF,MAAM,CAAC,MAAM,gBAAgB,GAAG,CAAmB,GAAW,EAAE,aAAgB,EAAE,cAAc,GAAG,KAAK,EAAE,EAAE,CAAC,kBAAkB,CAAC,YAAY,EAAE,GAAG,EAAE,aAAa,EAAE,cAAc,CAAC,CAAC;AAClL,MAAM,CAAC,MAAM,kBAAkB,GAAG,CAAmB,GAAW,EAAE,aAAgB,EAAE,EAAE,CAAC,kBAAkB,CAAC,cAAc,EAAE,GAAG,EAAE,aAAa,CAAC,CAAC","sourcesContent":["import { createStore } from '@stencil/store';\nimport { MinimumStorage } from './types';\n\nconst safeRead = <T extends object>(storage: MinimumStorage, key: string): T | null => {\n  try {\n    return JSON.parse(storage.getItem(key));\n  } catch {\n    return null;\n  }\n};\n\nconst debounce = fn => {\n  let called = false;\n  return () => {\n    if (called) {\n      return;\n    }\n    called = true;\n    setTimeout(() => {\n      fn();\n      called = false;\n    }, 0);\n  };\n};\n\nexport const createStorageStore = <T extends object>(storage: MinimumStorage, key: string, defaultValues: T, syncAcrossTabs = false) => {\n  const store = createStore(safeRead<T>(storage, key) ?? defaultValues, (newValue, oldValue) => {\n    return JSON.stringify(newValue) !== JSON.stringify(oldValue);\n  });\n\n  // Need to sync later or we would get ourselves in an infinite loop.\n  const write = debounce(() => storage.setItem(key, JSON.stringify(store.state)));\n  write();\n\n  if (syncAcrossTabs) {\n    window.addEventListener('storage', () => {\n      const currentState = safeRead<T>(storage, key);\n\n      if (currentState === null) {\n        return;\n      }\n\n      for (const key in currentState) {\n        store.set(key, currentState[key]);\n      }\n    });\n  }\n\n  store.use({ set: write, reset: write });\n\n  return store;\n};\n\nexport const createLocalStore = <T extends object>(key: string, defaultValues: T, syncAcrossTabs = false) => createStorageStore(localStorage, key, defaultValues, syncAcrossTabs);\nexport const createSessionStore = <T extends object>(key: string, defaultValues: T) => createStorageStore(sessionStorage, key, defaultValues);\n"]}