{"version":3,"file":"sc-cart-form.js","sourceRoot":"","sources":["../../../../../src/components/controllers/cart/sc-cart-form/sc-cart-form.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, h, Prop, State } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\n\nimport { convertLineItemsToLineItemData } from '../../../../functions/line-items';\nimport { createOrUpdateCheckout } from '../../../../services/session';\nimport { state as checkoutState } from '@store/checkout';\nimport uiStore from '@store/ui';\nimport { Checkout, LineItemData } from '../../../../types';\nimport { updateFormState } from '@store/form/mutations';\nconst query = {\n  expand: [\n    'line_items',\n    'line_item.price',\n    'price.product',\n    'customer',\n    'customer.shipping_address',\n    'payment_intent',\n    'discount',\n    'discount.promotion',\n    'discount.coupon',\n    'shipping_address',\n    'tax_identifier',\n  ],\n};\n\n@Component({\n  tag: 'sc-cart-form',\n  styles: 'sc-cart-form { display: inline-block }',\n  shadow: false,\n})\nexport class ScCartForm {\n  private form: HTMLScFormElement;\n\n  /** The quantity */\n  @Prop({ mutable: true }) quantity: number = 1;\n\n  /** The price id to add. */\n  @Prop() priceId: string;\n\n  /** The variant id to add. */\n  @Prop() variantId: string;\n\n  /** Are we in test or live mode. */\n  @Prop() mode: 'test' | 'live' = 'live';\n\n  /** The form id to use for the cart. */\n  @Prop({ reflect: true }) formId: string;\n\n  /** Is it busy */\n  @State() busy: boolean;\n  @State() error: string;\n\n  /** Find a line item with this price. */\n  getLineItem() {\n    const lineItem = (checkoutState?.checkout?.line_items?.data || []).find(item => {\n      if (this.variantId) {\n        return item.variant?.id === this.variantId && item.price?.id === this.priceId;\n      }\n      return item.price?.id === this.priceId;\n    });\n    if (!lineItem?.id) {\n      return false;\n    }\n    return {\n      id: lineItem?.id,\n      price_id: lineItem?.price?.id,\n      quantity: lineItem?.quantity,\n    } as LineItemData;\n  }\n\n  /** Add the item to cart. */\n  async addToCart() {\n    const { price } = await this.form.getFormJson();\n    try {\n      updateFormState('FETCH');\n      // if it's ad_hoc, update the amount. Otherwise increment the quantity.\n      checkoutState.checkout = await this.addOrUpdateLineItem({\n        ...(!!price ? { ad_hoc_amount: parseInt(price as string) || null } : {}),\n        ...(!!this.variantId ? { variant_id: (this.variantId as string) || null } : {}),\n      });\n      updateFormState('RESOLVE');\n      // store the checkout in localstorage and open the cart\n      uiStore.set('cart', { ...uiStore.state.cart, ...{ open: true } });\n    } catch (e) {\n      updateFormState('REJECT');\n      console.error(e);\n      this.error = e?.message || __('Something went wrong', 'surecart');\n    }\n  }\n\n  async addOrUpdateLineItem(data: any = {}) {\n    // get the current line item from the price id.\n    let lineItem = this.getLineItem() as LineItemData;\n\n    // convert line items response to line items post.\n    let existingData = convertLineItemsToLineItemData(checkoutState?.checkout?.line_items || []);\n\n    // Line item does not exist. Add it.\n    return (await createOrUpdateCheckout({\n      id: checkoutState?.checkout?.id,\n      data: {\n        live_mode: this.mode === 'live',\n        line_items: [\n          ...(existingData || []).map((item: LineItemData) => {\n            // if the price ids match (we have already a line item)\n            const priceOrVariantMatches = this.variantId ? item.price_id === this.priceId && item.variant_id === this.variantId : item.price_id === this.priceId;\n\n            if (priceOrVariantMatches) {\n              return {\n                ...item,\n                ...(!!data?.ad_hoc_amount ? { ad_hoc_amount: data?.ad_hoc_amount } : {}),\n                ...(!!data?.variant_id ? { variant_id: data?.variant_id } : {}),\n                quantity: !item?.ad_hoc_amount ? item?.quantity + 1 : 1, // only increase quantity if not ad_hoc.\n              };\n            }\n            // return item.\n            return item;\n          }),\n          // add a line item if one does not exist.\n          ...(!lineItem\n            ? [\n                {\n                  price_id: this.priceId,\n                  variant_id: this.variantId,\n                  ...(!!data?.ad_hoc_amount ? { ad_hoc_amount: data?.ad_hoc_amount } : {}),\n                  quantity: 1,\n                },\n              ]\n            : []),\n        ],\n      },\n      query: {\n        ...query,\n        form_id: this.formId,\n      },\n    })) as Checkout;\n  }\n\n  render() {\n    return (\n      <sc-form\n        ref={el => (this.form = el as HTMLScFormElement)}\n        onScSubmit={() => {\n          this.addToCart();\n        }}\n      >\n        {this.error && (\n          <sc-alert open={!!this.error} type=\"danger\">\n            <span slot=\"title\">{__('Error', 'surecart')}</span>\n            {this.error}\n          </sc-alert>\n        )}\n        <slot />\n      </sc-form>\n    );\n  }\n}\n"]}