{"version":3,"file":"sc-line-items-provider.js","sourceRoot":"","sources":["../../../../src/components/providers/line-items-provider/sc-line-items-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Event, EventEmitter, h, Listen, Prop, State, Watch } from '@stencil/core';\n\nimport { convertLineItemsToLineItemData } from '../../../functions/line-items';\nimport { Checkout, LineItemData } from '../../../types';\n\n@Component({\n  tag: 'sc-line-items-provider',\n  shadow: true,\n})\nexport class ScLineItemsProvider {\n  /** Order Object */\n  @Prop() order: Checkout;\n\n  /** Holds items to sync */\n  @State() syncItems: Array<{ type: 'toggle' | 'add' | 'remove' | 'update'; payload: LineItemData }> = [];\n\n  /** Update line items event */\n  @Event() scUpdateLineItems: EventEmitter<Array<LineItemData>>;\n\n  /** Handle line item toggle */\n  @Listen('scToggleLineItem')\n  handleLineItemToggle(e: CustomEvent) {\n    const lineItem = e.detail as LineItemData;\n    this.addSyncItem('toggle', lineItem);\n  }\n\n  /** Handle line item remove */\n  @Listen('scRemoveLineItem')\n  handleLineItemRemove(e: CustomEvent) {\n    const lineItem = e.detail as LineItemData;\n    this.addSyncItem('remove', lineItem);\n  }\n\n  /** Handle line item add */\n  @Listen('scAddLineItem')\n  handleLineItemAdd(e: CustomEvent) {\n    const lineItem = e.detail as LineItemData;\n    this.addSyncItem('add', lineItem);\n  }\n\n  /** Handle line item add */\n  @Listen('scUpdateLineItem')\n  handleLineItemUpdate(e: CustomEvent) {\n    const lineItem = e.detail as LineItemData;\n    this.addSyncItem('update', lineItem);\n  }\n\n  /** We listen to the syncItems array and run it on the next render in batch */\n  @Watch('syncItems')\n  async syncItemsHandler(val) {\n    if (!val?.length) return;\n    setTimeout(() => {\n      if (!this.syncItems?.length) return;\n      const items = this.processSyncItems();\n      this.scUpdateLineItems.emit(items);\n      this.syncItems = [];\n    }, 100);\n  }\n\n  /** Add item to sync */\n  addSyncItem(type: 'add' | 'remove' | 'toggle' | 'update', payload: LineItemData) {\n    this.syncItems = [...this.syncItems, ...[{ type, payload }]];\n  }\n\n  /** Batch process items to sync before sending */\n  processSyncItems() {\n    // get existing line item data.\n    let existingData = convertLineItemsToLineItemData(this?.order?.line_items || []);\n\n    const map = {\n      toggle: this.toggleItem,\n      add: this.addItem,\n      remove: this.removeItem,\n      update: this.updateItem,\n    };\n\n    // run existing data through chain of sync updates.\n    (this.syncItems || []).forEach(item => {\n      existingData = map[item.type](item.payload, existingData) as any;\n    });\n\n    return existingData;\n  }\n\n  /** Add item */\n  addItem(item: LineItemData, existingLineData: Array<LineItemData>) {\n    return [...existingLineData, ...[item]];\n  }\n\n  /** Toggle item */\n  toggleItem(item: LineItemData, existingLineData: Array<LineItemData>) {\n    // find existing item.\n    const existingPriceId = existingLineData.find(line => line.price_id === item.price_id)?.price_id;\n    // toggle it.\n    existingLineData = existingPriceId ? existingLineData.filter(item => existingPriceId !== item.price_id) : [...existingLineData, ...[item]];\n    // return.\n    return existingLineData;\n  }\n\n  /** Remove item */\n  removeItem(item: LineItemData, existingLineData: Array<LineItemData>) {\n    if (!item.price_id) return existingLineData;\n    return existingLineData.filter(data => data.price_id !== item.price_id);\n  }\n\n  /** Update the item item */\n  updateItem(item: LineItemData, existingLineData: Array<LineItemData>) {\n    // find existing item.\n    const existingLineItem = existingLineData.findIndex(line => line.price_id === item.price_id);\n    // if we found it, update it\n    if (existingLineItem !== -1) {\n      existingLineData[existingLineItem] = item;\n      // otherwise, add it\n    } else {\n      return [...existingLineData, ...[item]];\n    }\n\n    return existingLineData;\n  }\n\n  render() {\n    return <slot />;\n  }\n}\n"]}