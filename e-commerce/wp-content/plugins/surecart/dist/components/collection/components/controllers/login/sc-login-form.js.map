{"version":3,"file":"sc-login-form.js","sourceRoot":"","sources":["../../../../src/components/controllers/login/sc-login-form.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Fragment, h, State, Watch } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport apiFetch from '../../../functions/fetch';\nimport { ResponseError, VerificationCode } from '../../../types';\n\n@Component({\n  tag: 'sc-login-form',\n  styleUrl: 'sc-login-form.scss',\n  shadow: true,\n})\nexport class ScLogin {\n  private passwordInput: HTMLScInputElement;\n  private codeInput: HTMLScInputElement;\n\n  @State() step: number = 0;\n  @State() email: string = '';\n  @State() password: string = '';\n  @State() verifyCode: string = '';\n  @State() loading: boolean;\n  @State() error: ResponseError;\n\n  /** Focus the password field automatically on password step. */\n  @Watch('step')\n  handleStepChange() {\n    if (this.step === 1) {\n      setTimeout(() => {\n        this.passwordInput?.triggerFocus?.();\n      }, 50);\n    }\n    if (this.step === 2) {\n      setTimeout(() => {\n        this.codeInput?.triggerFocus?.();\n      }, 50);\n    }\n  }\n\n  /** Clear out error when loading happens. */\n  @Watch('loading')\n  handleLoadingChange(val) {\n    if (val) {\n      this.error = null;\n    }\n  }\n\n  @Watch('verifyCode')\n  handleVerifyCodeChange(val) {\n    if (val?.length >= 6) {\n      this.submitCode();\n    }\n  }\n\n  /** Handle request errors. */\n  handleError(e) {\n    console.error(this.error);\n    this.error = e || { message: __('Something went wrong', 'surecart') };\n  }\n\n  /** Submit for verification codes */\n  async createLoginCode() {\n    try {\n      this.loading = true;\n      await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/verification_codes',\n        data: {\n          login: this.email,\n        },\n      });\n      this.step = this.step + 1;\n    } catch (e) {\n      this.handleError(e);\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  /** Get all subscriptions */\n  async submitCode() {\n    try {\n      this.loading = true;\n      const { verified } = (await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/verification_codes/verify',\n        data: {\n          login: this.email,\n          code: this.verifyCode,\n        },\n      })) as VerificationCode;\n      if (!verified) {\n        throw { message: __('Verification code is not valid. Please try again.', 'surecart') };\n      }\n      window.location.reload();\n    } catch (e) {\n      this.handleError(e);\n      this.loading = false;\n    }\n  }\n\n  async login() {\n    try {\n      this.loading = true;\n      const { redirect_url } = (await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/login',\n        data: {\n          login: this.email,\n          password: this.password,\n        },\n      })) as any;\n      if (redirect_url) {\n        window.location.replace(redirect_url);\n      } else {\n        window.location.reload();\n      }\n    } catch (e) {\n      this.handleError(e);\n      this.loading = false;\n    }\n  }\n\n  async checkEmail() {\n    try {\n      this.loading = true;\n      await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/check_email',\n        data: {\n          login: this.email,\n        },\n      });\n      this.step = this.step + 1;\n    } catch (e) {\n      this.handleError(e);\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  renderInner() {\n    if (this.step === 2) {\n      return (\n        <Fragment>\n          <div class=\"login-form__title\" part=\"title\">\n            {__('Check your email for a confirmation code', 'surecart')}\n          </div>\n          <div>\n            <sc-form onScFormSubmit={() => this.submitCode()}>\n              <sc-input\n                label={__('Confirmation code', 'surecart')}\n                type=\"text\"\n                ref={el => (this.codeInput = el as HTMLScInputElement)}\n                autofocus\n                required\n                onScInput={e => (this.verifyCode = (e.target as HTMLScInputElement).value)}\n              ></sc-input>\n              <sc-button type=\"primary\" submit full>\n                <sc-icon name=\"lock\" slot=\"prefix\" />\n                {__('Login with Code', 'surecart')}\n              </sc-button>\n            </sc-form>\n          </div>\n        </Fragment>\n      );\n    }\n\n    if (this.step === 1 && this.email) {\n      return (\n        <Fragment>\n          <div class=\"login-form__title\" part=\"title\">\n            <div>{__('Welcome', 'surecart')}</div>\n            <sc-button style={{ fontSize: '18px' }} size=\"small\" pill caret onClick={() => (this.step = this.step - 1)}>\n              <sc-icon name=\"user\" slot=\"prefix\"></sc-icon>\n              {this.email}\n            </sc-button>\n          </div>\n          <sc-flex flexDirection=\"column\" style={{ '--sc-flex-column-gap': 'var(--sc-spacing-large)' }}>\n            <div>\n              <sc-form onScFormSubmit={() => this.createLoginCode()}>\n                <sc-button class=\"login-code\" type=\"primary\" submit full>\n                  <sc-icon name=\"mail\" slot=\"prefix\" />\n                  {__('Send a login code', 'surecart')}\n                </sc-button>\n              </sc-form>\n              <sc-divider style={{ '--spacing': '0.5em' }}>{__('or', 'surecart')}</sc-divider>\n              <sc-form onScFormSubmit={() => this.login()}>\n                <sc-input\n                  label={__('Enter your password', 'surecart')}\n                  type=\"password\"\n                  ref={el => (this.passwordInput = el as HTMLScInputElement)}\n                  onKeyDown={e => e.key === 'Enter' && this.login()}\n                  autofocus\n                  required\n                  onScInput={e => (this.password = (e.target as HTMLScInputElement).value)}\n                ></sc-input>\n                <sc-button type=\"primary\" outline submit full>\n                  <sc-icon name=\"lock\" slot=\"prefix\" />\n                  {__('Login', 'surecart')}\n                </sc-button>\n              </sc-form>\n            </div>\n          </sc-flex>\n        </Fragment>\n      );\n    }\n\n    return (\n      <Fragment>\n        <div class=\"login-form__title\" part=\"title\">\n          <slot name=\"title\"></slot>\n        </div>\n\n        <sc-form onScFormSubmit={() => this.checkEmail()}>\n          <sc-input\n            type=\"text\"\n            value={this.email}\n            label={__('Username or Email Address', 'surecart')}\n            onScInput={e => (this.email = (e.target as HTMLScInputElement).value)}\n            onKeyDown={e => e.key === 'Enter' && this.checkEmail()}\n            required\n            autofocus\n          />\n          <sc-button type=\"primary\" submit full>\n            <sc-icon name=\"arrow-right\" slot=\"suffix\" />\n            {__('Next', 'surecart')}\n          </sc-button>\n        </sc-form>\n      </Fragment>\n    );\n  }\n\n  render() {\n    return (\n      <div class=\"login-form\">\n        <sc-card>\n          {!!this.error && (\n            <sc-alert open type=\"danger\" closable onScHide={() => (this.error = null)}>\n              <span slot=\"title\" innerHTML={this.error?.message}></span>\n              {(this.error?.additional_errors || []).map(({ message }) => (\n                <div innerHTML={message}></div>\n              ))}\n            </sc-alert>\n          )}\n          {this.renderInner()}\n        </sc-card>\n        {this.loading && <sc-block-ui spinner style={{ 'zIndex': '9', '--sc-block-ui-opacity': '0.5' }}></sc-block-ui>}\n      </div>\n    );\n  }\n}\n"]}