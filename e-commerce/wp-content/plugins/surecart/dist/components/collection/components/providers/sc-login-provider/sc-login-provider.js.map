{"version":3,"file":"sc-login-provider.js","sourceRoot":"","sources":["../../../../src/components/providers/sc-login-provider/sc-login-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Prop, h, Watch, State, Host, Listen, Event, EventEmitter } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport apiFetch from '../../../functions/fetch';\nimport { Checkout } from '../../../types';\n\n@Component({\n  tag: 'sc-login-provider',\n  styleUrl: 'sc-login-provider.css',\n  shadow: true,\n})\nexport class ScLoginProvider {\n  private loginForm: HTMLScFormElement;\n\n  /** Is the user logged in. */\n  @Prop() loggedIn: boolean;\n  @Prop() order: Checkout;\n\n  @Event() scSetLoggedIn: EventEmitter<boolean>;\n  @Event() scSetCustomer: EventEmitter<{ email: string; name?: string }>;\n\n  @State() notice: boolean;\n  @State() open: boolean;\n  @State() loading: boolean;\n  @State() error: string;\n\n  /** Listen for open event. */\n  @Listen('scLoginPrompt')\n  handleLoginPrompt() {\n    this.open = true;\n  }\n\n  /** Focus on first input. */\n  @Watch('open')\n  handleLoginDialogChange(val) {\n    if (val) {\n      setTimeout(() => {\n        this.loginForm.querySelector('sc-input').triggerFocus();\n      }, 100);\n    }\n  }\n\n  @Watch('loggedIn')\n  handleLoggedInChange(val, prev) {\n    if (prev === false && val) {\n      this.notice = true;\n    }\n  }\n\n  @Watch('order')\n  handleOrderChange(val, prev) {\n    if (val?.updated_at !== prev?.updated_at) {\n      this.notice = false;\n    }\n  }\n\n  /** Handle form submit. */\n  async handleFormSubmit(e) {\n    e.preventDefault();\n    e.stopImmediatePropagation();\n    this.error = null;\n\n    const { login, password } = await e.target.getFormJson();\n\n    try {\n      this.loading = true;\n      const { name, email } = (await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/login',\n        data: {\n          login,\n          password,\n        },\n      })) as { name: string; email: string };\n      this.scSetLoggedIn.emit(true);\n      this.scSetCustomer.emit({ name, email });\n      this.open = false;\n    } catch (e) {\n      console.error(e);\n      this.error = e?.message || __('Something went wrong', 'surecart');\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  render() {\n    return (\n      <Host>\n        {!!this.notice && (\n          <sc-alert type=\"success\" open style={{ marginBottom: 'var(--sc-form-row-spacing)' }} closable>\n            <span slot=\"title\">{__('Welcome back!', 'surecart')}</span>\n            {__('You have logged in successfully.', 'surecart')}\n          </sc-alert>\n        )}\n\n        <slot />\n\n        {!this.loggedIn && (\n          <sc-dialog label={__('Login to your account', 'surecart')} open={this.open} onScRequestClose={() => (this.open = false)}>\n            <sc-form\n              ref={el => (this.loginForm = el as HTMLScFormElement)}\n              onScFormSubmit={e => {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n              }}\n              onScSubmit={e => this.handleFormSubmit(e)}\n            >\n              {!!this.error && (\n                <sc-alert type=\"danger\" open={!!this.error}>\n                  {this.error}\n                </sc-alert>\n              )}\n              <sc-input label={__('Email or Username', 'surecart')} type=\"text\" name=\"login\" required autofocus={this.open}></sc-input>\n              <sc-input label={__('Password', 'surecart')} type=\"password\" name=\"password\" required></sc-input>\n              <sc-button type=\"primary\" full loading={this.loading} submit>\n                {__('Login', 'surecart')}\n              </sc-button>\n            </sc-form>\n          </sc-dialog>\n        )}\n      </Host>\n    );\n  }\n}\n"]}