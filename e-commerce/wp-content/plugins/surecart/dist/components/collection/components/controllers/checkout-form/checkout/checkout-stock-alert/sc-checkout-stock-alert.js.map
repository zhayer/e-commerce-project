{"version":3,"file":"sc-checkout-stock-alert.js","sourceRoot":"","sources":["../../../../../../src/components/controllers/checkout-form/checkout/checkout-stock-alert/sc-checkout-stock-alert.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Host, h, State, EventEmitter, Event } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport { Checkout, LineItemData, Product } from 'src/types';\nimport { state as checkoutState } from '@store/checkout';\nimport { updateCheckout } from '@services/session';\nimport { currentFormState } from '@store/form/getters';\n\n/**\n * This component listens for stock requirements and displays a dialog to the user.\n */\n@Component({\n  tag: 'sc-checkout-stock-alert',\n  styleUrl: 'sc-checkout-stock-alert.scss',\n  shadow: true,\n})\nexport class ScCheckoutStockAlert {\n  /** Stock errors */\n  @State() stockErrors: Array<any> = [];\n\n  /** Toggle line item event */\n  @Event() scUpdateLineItem: EventEmitter<LineItemData>;\n\n  /** Is it busy */\n  @State() busy: boolean;\n\n  /** Update stock error. */\n  @State() error: string;\n\n  /** Get the out of stock line items. */\n  getOutOfStockLineItems() {\n    return (checkoutState.checkout?.line_items?.data || []).filter(lineItem => {\n      const product = lineItem.price?.product as Product;\n\n      // this item is not out of stock, don't include it.\n      if (lineItem?.purchasable_status !== 'out_of_stock') return false;\n\n      // check the variant stock.\n      if (lineItem?.variant?.id) {\n        return lineItem?.variant?.available_stock < lineItem.quantity;\n      }\n\n      return product?.available_stock < lineItem.quantity;\n    });\n  }\n\n  /**\n   * Update the checkout line items stock to the max available.\n   */\n  async onSubmit() {\n    const lineItems = this.getOutOfStockLineItems().map(lineItem => {\n      const product = lineItem.price?.product as Product;\n\n      if (lineItem?.variant?.id) {\n        return {\n          ...lineItem,\n          quantity: Math.max(lineItem?.variant?.available_stock || 0, 0),\n        };\n      }\n\n      return {\n        ...lineItem,\n        quantity: Math.max(product?.available_stock || 0, 0),\n      };\n    });\n\n    try {\n      this.busy = true;\n      checkoutState.checkout = (await updateCheckout({\n        id: checkoutState.checkout.id,\n        data: {\n          line_items: (lineItems || [])\n            .filter(lineItem => !!lineItem.quantity)\n            .map(lineItem => {\n              return {\n                id: lineItem.id,\n                price_id: lineItem.price?.id,\n                quantity: lineItem.quantity,\n                ...(lineItem?.variant?.id ? { variant: lineItem.variant.id } : {}),\n              };\n            }),\n        },\n      })) as Checkout;\n    } catch (error) {\n      const additionalErrors = (error?.additional_errors || []).map(error => error?.message).filter(n => n);\n      this.error = `${error?.message || __('Something went wrong.', 'surecart')} ${additionalErrors?.length && ` ${additionalErrors.join('. ')}`}`;\n    } finally {\n      this.busy = false;\n    }\n  }\n\n  render() {\n    // stock errors.\n    const stockErrors = (this.getOutOfStockLineItems() || []).map(lineItem => {\n      const product = lineItem.price?.product as Product;\n      const available_stock = lineItem?.variant?.id ? lineItem?.variant?.available_stock : product?.available_stock;\n\n      return {\n        name: product?.name,\n        image: lineItem?.image,\n        quantity: lineItem.quantity,\n        available_stock,\n      };\n    });\n\n    // we have at least one quantity change.\n    const hasOutOfStockItems = stockErrors?.some(item => item?.available_stock < 1);\n\n    return (\n      <Host>\n        <sc-dialog open={!!stockErrors.length && currentFormState() === 'draft'} noHeader={true} onScRequestClose={e => e.preventDefault()} class=\"stock-alert\">\n          <sc-dashboard-module class=\"subscription-cancel\" error={this.error} style={{ '--sc-dashboard-module-spacing': '1em' }}>\n            <sc-flex slot=\"heading\" align-items=\"center\" justify-content=\"flex-start\">\n              <sc-icon name=\"alert-circle\" style={{ color: 'var(--sc-color-primary-500' }}></sc-icon>\n              {hasOutOfStockItems ? __('Out of Stock', 'surecart') : __('Quantity Update', 'surecart')}\n            </sc-flex>\n            <span slot=\"description\">\n              {hasOutOfStockItems\n                ? __('Some items are no longer available. Your cart will be updated.', 'surecart')\n                : __('Available quantities for these items have changed. Your cart will be updated.', 'surecart')}\n            </span>\n\n            <sc-card no-padding>\n              <sc-table>\n                <sc-table-cell slot=\"head\">{__('Description', 'surecart')}</sc-table-cell>\n                <sc-table-cell slot=\"head\" style={{ width: '100px', textAlign: 'right' }}>\n                  {__('Quantity', 'surecart')}\n                </sc-table-cell>\n\n                {stockErrors.map((item, index) => {\n                  const isLastChild = index === stockErrors.length - 1;\n                  return (\n                    <sc-table-row\n                      style={{\n                        '--columns': '2',\n                        ...(isLastChild ? { border: 'none' } : {}),\n                      }}\n                    >\n                      <sc-table-cell>\n                        <sc-flex justifyContent=\"flex-start\" alignItems=\"center\">\n                          {item?.image && <img {...(item.image as any)} class=\"stock-alert__image\" />}\n                          <h4>{item.name}</h4>\n                        </sc-flex>\n                      </sc-table-cell>\n                      <sc-table-cell style={{ width: '100px', textAlign: 'right' }}>\n                        <span class=\"stock-alert__quantity\">\n                          <span>{item?.quantity}</span> <sc-icon name=\"arrow-right\" /> <span>{Math.max(item?.available_stock, 0)}</span>\n                        </span>\n                      </sc-table-cell>\n                    </sc-table-row>\n                  );\n                })}\n              </sc-table>\n            </sc-card>\n          </sc-dashboard-module>\n\n          <sc-button slot=\"footer\" type=\"primary\" loading={this.busy} onClick={() => this.onSubmit()}>\n            {__('Continue', 'surecart')}\n            <sc-icon name=\"arrow-right\" slot=\"suffix\" />\n          </sc-button>\n\n          {this.busy && <sc-block-ui spinner></sc-block-ui>}\n        </sc-dialog>\n      </Host>\n    );\n  }\n}\n"]}