{"version":3,"file":"sc-cart.js","sourceRoot":"","sources":["../../../../../src/components/controllers/cart/sc-cart/sc-cart.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Fragment, h, Listen, Prop, State, Watch, Element } from '@stencil/core';\nimport apiFetch from '../../../../functions/fetch';\nimport { addQueryArgs } from '@wordpress/url';\nimport { baseUrl } from '../../../../services/session';\nimport { getCheckout, setCheckout, clearCheckout } from '@store/checkouts/mutations';\nimport { state as checkoutState } from '@store/checkout';\nimport uiStore from '@store/ui';\nimport { expand } from '../../../../services/session';\nimport { Checkout } from '../../../../types';\nimport { createErrorNotice } from '@store/notices/mutations';\nimport { updateFormState } from '@store/form/mutations';\nimport { formBusy } from '@store/form/getters';\n@Component({\n  tag: 'sc-cart',\n  styleUrl: 'sc-cart.scss',\n  shadow: true,\n})\nexport class ScCart {\n  @Element() el: HTMLScCartElement;\n\n  /** Is this open or closed? */\n  @State() open: boolean = null;\n\n  /** The form id to use for the cart. */\n  @Prop({ reflect: true }) formId: string;\n\n  /** The header for the popout. */\n  @Prop() header: string;\n\n  @Prop() checkoutLink: string;\n\n  /** The template for the cart to inject when opened. */\n  @Prop() cartTemplate: string;\n\n  /** Are we in test or live mode. */\n  @Prop() mode: 'test' | 'live' = 'live';\n\n  /** The checkout url for the button. */\n  @Prop() checkoutUrl: string;\n\n  /** Should we force show the cart, even if there's a form on the page? */\n  @Prop() alwaysShow: boolean;\n\n  /** Whether the floating button should be visible */\n  @Prop() floatingIconEnabled: boolean = true;\n\n  /** The current UI state. */\n  @State() uiState: 'loading' | 'busy' | 'navigating' | 'idle' = 'idle';\n\n  @Watch('open')\n  handleOpenChange() {\n    uiStore.set('cart', { ...uiStore.state.cart, ...{ open: this.open } });\n    if (this.open === true) {\n      this.fetchOrder();\n    } else {\n      (document?.querySelector('sc-cart-icon')?.shadowRoot?.querySelector('.cart') as HTMLElement)?.focus();\n    }\n  }\n\n  order() {\n    return getCheckout(this.formId, this.mode);\n  }\n\n  setCheckout(data) {\n    setCheckout(data, this.formId);\n  }\n\n  /**\n   * Search for the sc-checkout component on a page to make sure\n   * we don't show the cart on a checkout page.\n   */\n  pageHasForm() {\n    return !!document.querySelector('sc-checkout');\n  }\n\n  /** Count the number of items in the cart. */\n  getItemsCount() {\n    const items = checkoutState.checkout?.line_items?.data;\n    let count = 0;\n    (items || []).forEach(item => {\n      count = count + item?.quantity;\n    });\n    return count;\n  }\n\n  @Listen('scSetState')\n  handleSetState(e) {\n    this.uiState = e.detail;\n  }\n\n  @Listen('scCloseCart')\n  handleCloseCart() {\n    this.open = false;\n  }\n\n  /** Fetch the order */\n  async fetchOrder() {\n    if (!checkoutState.checkout?.id) {\n      return;\n    }\n\n    try {\n      updateFormState('FETCH');\n      checkoutState.checkout = (await apiFetch({\n        method: 'GET', // create or update\n        path: addQueryArgs(`${baseUrl}${checkoutState.checkout?.id}`, {\n          expand,\n        }),\n      })) as Checkout;\n      updateFormState('RESOLVE');\n    } catch (e) {\n      console.error(e);\n      updateFormState('REJECT');\n      createErrorNotice(e);\n\n      if(e?.code === 'checkout.not_found') {\n        clearCheckout(this.formId, this.mode);\n      }\n    }\n  }\n\n  componentWillLoad() {\n    this.open = !!uiStore.state.cart.open;\n    uiStore.onChange('cart', cart => {\n      this.open = cart.open;\n    });\n  }\n\n  state() {\n    return {\n      uiState: this.uiState,\n      checkoutLink: this.checkoutLink,\n      loading: this.uiState === 'loading',\n      busy: this.uiState === 'busy',\n      navigating: this.uiState === 'navigating',\n      empty: !checkoutState.checkout?.line_items?.pagination?.count,\n      order: checkoutState.checkout,\n      lineItems: checkoutState.checkout?.line_items?.data || [],\n      tax_status: checkoutState.checkout?.tax_status,\n      customerShippingAddress: typeof checkoutState.checkout?.customer !== 'string' ? checkoutState.checkout?.customer?.shipping_address : {},\n      shippingAddress: checkoutState.checkout?.shipping_address,\n      taxStatus: checkoutState.checkout?.tax_status,\n      formId: this.formId,\n    };\n  }\n\n  render() {\n    return (\n      <sc-cart-session-provider>\n        <sc-drawer\n          open={this.open}\n          onScAfterShow={() => (this.open = true)}\n          onScAfterHide={() => {\n            this.open = false;\n          }}\n        >\n          {this.open === true && (\n            <Fragment>\n              <div class=\"cart__header-suffix\" slot=\"header\">\n                <slot name=\"cart-header\" />\n                <sc-error style={{ '--sc-alert-border-radius': '0' }} slot=\"header\"></sc-error>\n              </div>\n              <slot />\n            </Fragment>\n          )}\n          {formBusy() && <sc-block-ui z-index={9}></sc-block-ui>}\n        </sc-drawer>\n      </sc-cart-session-provider>\n    );\n  }\n}\n"]}