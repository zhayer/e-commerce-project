{"version":3,"file":"sc-cart-session-provider.js","sourceRoot":"","sources":["../../../../src/components/providers/cart-session-provider/sc-cart-session-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Element, Event, EventEmitter, h, Listen } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport { state as checkoutState } from '@store/checkout';\n\nimport { updateCheckout } from '../../../services/session';\nimport { Checkout, LineItemData } from '../../../types';\nimport { createErrorNotice } from '@store/notices/mutations';\nimport { updateFormState } from '@store/form/mutations';\nimport { clearCheckout } from '@store/checkout/mutations';\n\n@Component({\n  tag: 'sc-cart-session-provider',\n  shadow: true,\n})\nexport class ScCartSessionProvider {\n  /** Element */\n  @Element() el: HTMLElement;\n\n  /** Set the state */\n  @Event() scSetState: EventEmitter<'loading' | 'busy' | 'navigating' | 'idle'>;\n\n  @Listen('scUpdateOrder')\n  handleUpdateSession(e) {\n    const { data, options } = e.detail;\n    if (options?.silent) {\n      this.update(data);\n    } else {\n      this.loadUpdate(data);\n    }\n  }\n\n  /** Handle the error response. */\n  handleErrorResponse(e) {\n    if (e?.code === 'readonly' || e?.additional_errors?.[0]?.code === 'checkout.customer.account_mismatch') {\n      clearCheckout();\n    }\n\n    // expired\n    if (e?.code === 'rest_cookie_invalid_nonce') {\n      updateFormState('EXPIRE');\n      return;\n    }\n\n    // something went wrong\n    if (e?.message) {\n      createErrorNotice(e);\n    }\n\n    // handle curl timeout errors.\n    if (e?.code === 'http_request_failed') {\n      createErrorNotice(__('Something went wrong. Please reload the page and try again.', 'surecart'));\n    }\n  }\n\n  /** Fetch a session. */\n  async fetch(args = {}) {\n    this.loadUpdate({ status: 'draft', ...args });\n  }\n\n  /** Update a the order */\n  async update(data = {}, query = {}) {\n    try {\n      checkoutState.checkout = (await updateCheckout({\n        id: checkoutState.checkout?.id,\n        data: {\n          ...data,\n        },\n        query: {\n          ...query,\n        },\n      })) as Checkout;\n    } catch (e) {\n      console.error(e);\n      throw e;\n    }\n  }\n\n  /** Updates a session with loading status changes. */\n  async loadUpdate(data = {}) {\n    try {\n      updateFormState('FETCH');\n      await this.update(data);\n      updateFormState('RESOLVE');\n    } catch (e) {\n      updateFormState('REJECT');\n      this.handleErrorResponse(e);\n    }\n  }\n\n  render() {\n    return (\n      <sc-line-items-provider order={checkoutState.checkout} onScUpdateLineItems={e => this.loadUpdate({ line_items: e.detail as Array<LineItemData> })}>\n        <slot />\n      </sc-line-items-provider>\n    );\n  }\n}\n"]}