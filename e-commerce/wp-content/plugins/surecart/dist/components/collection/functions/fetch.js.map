{"version":3,"file":"fetch.js","sourceRoot":"","sources":["../../src/functions/fetch.ts"],"names":[],"mappings":"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","sourcesContent":["import apiFetch from '@wordpress/api-fetch';\nimport { __, sprintf } from '@wordpress/i18n';\nimport { addQueryArgs } from '@wordpress/url';\n\napiFetch.fetchAllMiddleware = null;\n\napiFetch.use(apiFetch.createRootURLMiddleware(window?.parent?.scData?.root_url || window?.scData?.root_url));\n\nif (window?.scData?.nonce) {\n  // @ts-ignore\n  apiFetch.nonceMiddleware = apiFetch.createNonceMiddleware(window?.scData?.nonce);\n  // @ts-ignore\n  apiFetch.use(apiFetch.nonceMiddleware);\n}\n\nif (window?.scData?.nonce_endpoint) {\n  // @ts-ignore\n  apiFetch.nonceEndpoint = window?.scData?.nonce_endpoint;\n}\n\n// Add a timestamp so it can bypass cache rest api\napiFetch.use((options, next) => {\n  options.path = addQueryArgs(options.path, { t: Date.now() });\n  return next(options);\n});\n\napiFetch.use((options, next) => {\n  const result = next(options);\n  result.catch(response => {\n    if (response.code === 'invalid_json') {\n      response.message = __('The response is not a valid JSON response.', 'surecart');\n      const debugSettingsUrl = 'https://surecart.com/docs/is-not-a-valid-json-response/';\n      response.additional_errors = [\n        {\n          code: 'invalid_json',\n          message: sprintf(\n            /* translators: %s: URL to debug settings page */\n            __('Please ensure that your site is not in debug mode as this may interfere with API responses. %s', 'surecart'),\n            `<a href=\"${debugSettingsUrl}\" target=\"_blank\" rel=\"noopener noreferrer\">${__('More Information', 'surecart')}</a>`,\n          ),\n        },\n      ];\n    }\n    return Promise.reject(response);\n  });\n\n  return result;\n});\n\nexport default apiFetch;\n\n/**\n * Calls the `json` function on the Response, throwing an error if the response\n * doesn't have a json function or if parsing the json itself fails.\n *\n * @param {Response} response\n * @return {Promise<any>} Parsed response.\n */\nexport const parseJsonAndNormalizeError = response => {\n  const invalidJsonError = {\n    code: 'invalid_json',\n    message: __('The response is not a valid JSON response.', 'surecart'),\n  };\n\n  if (response?.code && response?.message) {\n    throw response;\n  }\n\n  if (!response || !response.json) {\n    throw invalidJsonError;\n  }\n\n  return response.json().catch(() => {\n    throw invalidJsonError;\n  });\n};\n\nexport const handleNonceError = async response => {\n  // need to parse the error response since we are bypassing the apiFetch middleware.\n  const error = await parseJsonAndNormalizeError(response);\n\n  if (error.code !== 'rest_cookie_invalid_nonce') {\n    // console.error(error);\n    throw error;\n  }\n\n  // If the nonce is invalid, refresh it and try again.\n  return (\n    window\n      // @ts-ignore\n      .fetch(apiFetch.nonceEndpoint)\n      .then(response => {\n        if (response.status >= 200 && response.status < 300) {\n          return response;\n        }\n        throw response;\n      })\n      .then(data => data.text())\n      .then(text => {\n        // @ts-ignore\n        apiFetch.nonceMiddleware.nonce = text;\n      })\n  );\n};\n"]}